<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pelikán Kezelőpult | Profil</title>
    <link rel="stylesheet" href="dashboard.css">
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
    <style>
        /* Profil oldal speciális stílusok */
        .profile-container {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            margin-top: 20px;
        }
        
        @media (max-width: 992px) {
            .profile-container {
                grid-template-columns: 1fr;
            }
        }
        
        .profile-sidebar {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        
        .profile-main {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        
        .profile-avatar {
            position: relative;
            margin-bottom: 25px;
        }
        
        .profile-avatar-img {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            object-fit: cover;
            border: 6px solid #e0e7ff;
            box-shadow: 0 8px 20px rgba(24, 145, 209, 0.15);
        }
        
        .profile-avatar-edit {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: #1891d1;
            color: white;
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(24, 145, 209, 0.3);
            transition: all 0.3s ease;
        }
        
        .profile-avatar-edit:hover {
            background: #1474a9;
            transform: scale(1.05);
        }
        
        .profile-avatar-edit ion-icon {
            font-size: 24px;
        }
        
        .profile-info {
            width: 100%;
        }
        
        .profile-name {
            font-size: 24px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 8px;
        }
        
        .profile-email {
            color: #6b7280;
            font-size: 16px;
            margin-bottom: 20px;
            word-break: break-all;
        }
        
        .profile-roles {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin-bottom: 25px;
        }
        
        .role-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .role-writer { background: #dbeafe; color: #1e40af; }
        .role-lector { background: #fef3c7; color: #92400e; }
        .role-director { background: #fce7f3; color: #9d174d; }
        .role-frontend { background: #dcfce7; color: #166534; }
        .role-backend { background: #f3e8ff; color: #6b21a8; }
        .role-star { background: #fef9c3; color: #854d0e; }
        
        .profile-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            width: 100%;
            margin-top: 25px;
            padding-top: 25px;
            border-top: 1px solid #e5e7eb;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-number {
            display: block;
            font-size: 24px;
            font-weight: 700;
            color: #1891d1;
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 12px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Profil beállítások kártyák */
        .profile-settings-card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #1891d1;
        }
        
        .profile-settings-card h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 25px;
            color: #2d3748;
            font-size: 18px;
            font-weight: 600;
        }
        
        .profile-settings-card h3 ion-icon {
            color: #1891d1;
            font-size: 24px;
        }
        
        /* Háttérkép kiválasztó */
        .background-selector {
            margin-top: 20px;
        }
        
        .background-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .background-option {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s ease;
            aspect-ratio: 16/9;
        }
        
        .background-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }
        
        .background-option.selected {
            border-color: #1891d1;
        }
        
        .background-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .background-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .background-option:hover .background-overlay {
            opacity: 1;
        }
        
        .background-select-btn {
            background: white;
            color: #1891d1;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        /* Egyedi háttér feltöltés */
        .custom-background-upload {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px dashed #d1d5db;
        }
        
        .upload-area {
            text-align: center;
            padding: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .upload-area:hover {
            background: #e5e7eb;
        }
        
        .upload-area ion-icon {
            font-size: 48px;
            color: #6b7280;
            margin-bottom: 15px;
        }
        
        .upload-area p {
            margin-bottom: 15px;
            color: #4b5563;
        }
        
        /* Jelszó módosítás */
        .password-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .password-form {
                grid-template-columns: 1fr;
            }
        }
        
        /* Social links grid */
        .social-links-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .social-links-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Vissza gomb */
        .back-btn-container {
            margin-top: 30px;
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }
        
        /* Modal styles for image upload */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }
        
        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .modal-header h3 {
            margin: 0;
            color: #2d3748;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            color: #6b7280;
            cursor: pointer;
            line-height: 1;
        }
        
        .modal-close:hover {
            color: #2d3748;
        }
        
        /* Loading animation */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #6b7280;
        }
        
        .loading ion-icon {
            font-size: 48px;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Notification styles */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 3000;
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }
        
        .notification.error {
            background: #ef4444;
        }
        
        .notification.warning {
            background: #f59e0b;
        }
        
        /* File upload preview */
        .upload-preview {
            margin-top: 20px;
            text-align: center;
        }
        
        .preview-image {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        /* Form actions */
        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 25px;
        }

        /* Progress bar stílusok */
.upload-progress {
    text-align: center;
}

.progress-bar {
    width: 100%;
    height: 8px;
    background-color: #e0e7ff;
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 8px;
}

.progress-fill {
    height: 100%;
    background-color: #1891d1;
    transition: width 0.3s ease;
}

.progress-text {
    font-size: 12px;
    color: #6b7280;
}
    </style>
</head>

<body>
    <!-- Oldalsáv -->
    <div class="mobile-menu-btn"><ion-icon name="menu-outline"></ion-icon></div>
    <nav id="sidebar">
        <div class="logo">
            <div class="logo-image">
                <img src="/pelikan2.png" alt="Logo">
                <span class="logo-text">Pelikán Admin</span>
            </div>
            <div class="close-sidebar"><ion-icon name="close-outline"></ion-icon></div>
        </div>
        <div class="menu-items">
            <ul class="navLinks">
                <li class="navList" data-target="dashboard">
                    <a href="dashboard.html">
                        <ion-icon name="home-outline"></ion-icon>
                        <span class="links">Dashboard</span>
                    </a>
                </li>
                <li class="navList" data-target="profile">
                    <a href="#">
                        <ion-icon name="person-outline"></ion-icon>
                        <span class="links">Profilom</span>
                    </a>
                </li>
                <li class="navList" data-target="settings">
                    <a href="settings.html">
                        <ion-icon name="settings-outline"></ion-icon>
                        <span class="links">Beállítások</span>
                    </a>
                </li>
            </ul>
            <ul class="bottom-link">
                <li>
                    <a href="../logout.php">
                        <ion-icon name="log-out-outline"></ion-icon>
                        <span class="links">Kijelentkezés</span>
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    <!-- Tartalom -->
    <section class="dashboard">
        <div class="container">
            <!-- Fejléc -->
            <div class="dashboard-header">
                <div class="header-left">
                    <h1>Profilom</h1>
                    <p class="page-description">Személyre szabható profilbeállítások</p>
                </div>
                <div class="header-right">
                    <div class="search-box">
                        <ion-icon name="search-outline"></ion-icon>
                        <input type="text" placeholder="Keresés...">
                    </div>
                    <div class="user-profile">
                        <div class="profile-img" id="profile-toggle-btn">
                            <img id="user-profile-image" src="https://ui-avatars.com/api/?name=Guest&background=666&color=fff" alt="Profil">
                        </div>
                        <div class="profile-dropdown" id="profile-dropdown">
                            <div class="dropdown-content" id="dropdown-content">
                                <!-- Tartalom JavaScript alapján töltődik -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profil tartalom -->
            <div class="profile-container">
                <!-- Bal oldali sidebar -->
                <div class="profile-sidebar">
                    <div class="profile-avatar">
                        <img id="profile-avatar-img" class="profile-avatar-img" src="https://ui-avatars.com/api/?name=Guest&background=1891d1&color=fff&size=180" alt="Profilkép">
                        <button class="profile-avatar-edit" id="edit-avatar-btn">
                            <ion-icon name="camera-outline"></ion-icon>
                        </button>
                    </div>
                    
                    <div class="profile-info">
                        <h2 id="profile-display-name" class="profile-name">Vendég</h2>
                        <div id="profile-email" class="profile-email">Nincs bejelentkezve</div>
                        
                        <div id="profile-roles-container" class="profile-roles">
                            <!-- Rangok ide töltődnek -->
                        </div>
                        
                        <div class="profile-stats">
                            <div class="stat-item">
                                <span id="articles-count" class="stat-number">0</span>
                                <span class="stat-label">Cikkek</span>
                            </div>

                            <!-- majd kitaláljuk h legyen e
                            <div class="stat-item">
                                <span id="joined-date" class="stat-number">-</span>
                                <span class="stat-label">Csatlakozás</span>
                            </div>

                            -->
                        </div>
                        
                        <div class="back-btn-container">
                            <a href="dashboard.html" class="btn-secondary">
                                <ion-icon name="arrow-back-outline"></ion-icon>
                                Vissza a Dashboardra
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- Jobb oldali fő tartalom -->
                <div class="profile-main">
                    <!-- Profil adatok -->
                    <div class="profile-settings-card">
                        <h3><ion-icon name="person-circle-outline"></ion-icon> Alapvető információk</h3>
                        <form id="basic-info-form">
                            <div class="form-group">
                                <label for="profile-alias">Írói név / Alias</label>
                                <input type="text" id="profile-alias" placeholder="Írd be az írói neved...">
                                <small class="form-help">Ez a név jelenik meg a publikált cikkek mellett.</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="profile-description">Bemutatkozás</label>
                                <textarea id="profile-description" rows="4" placeholder="Írj egy rövid bemutatkozást..."></textarea>
                                <small class="form-help">Ez jelenik meg a profilod oldalán.</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="profile-face">Facebook profil</label>
                                <input type="text" id="profile-face" placeholder="https://facebook.com/profilod">
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" class="btn-secondary" onclick="resetBasicInfoForm()">Alaphelyzet</button>
                                <button type="submit" class="btn-primary">Mentés</button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Közösségi média linkek -->
                    <div class="profile-settings-card">
                        <h3><ion-icon name="share-social-outline"></ion-icon> Közösségi média linkek</h3>
                        <div class="social-links-grid">
                            <div class="form-group">
                                <label for="profile-dc">Discord felhasználónév</label>
                                <input type="text" id="profile-dc" placeholder="@felhasználónév">
                            </div>
                            <div class="form-group">
                                <label for="profile-yt">YouTube csatorna</label>
                                <input type="text" id="profile-yt" placeholder="/@csatorna">
                            </div>
                            <div class="form-group">
                                <label for="profile-instagram">Instagram</label>
                                <input type="text" id="profile-instagram" placeholder="@felhasználónév">
                            </div>
                            <div class="form-group">
                                <label for="profile-wattpad">Wattpad</label>
                                <input type="text" id="profile-wattpad" placeholder="Wattpad felhasználónév">
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn-secondary" onclick="resetSocialLinksForm()">Alaphelyzet</button>
                            <button type="button" class="btn-primary" onclick="saveSocialLinks()">Mentés</button>
                        </div>
                    </div>
                    

                    
                    <!-- Profil hátterek -->
                    <div class="profile-settings-card">
                        <h3><ion-icon name="image-outline"></ion-icon> Profil háttér</h3>
                        <div class="background-selector">
                            <p>Válassz egy hátteret a profilodhoz:</p>
                            
                            <div class="background-options" id="background-options">
                                <!-- Háttér opciók betöltődnek ide -->
                                <div class="loading">
                                    <ion-icon name="sync-outline"></ion-icon>
                                    <p>Háttér opciók betöltése...</p>
                                </div>
                            </div>
                            
                            <div class="custom-background-upload">
                                <div class="upload-area" id="upload-background-area">
                                    <ion-icon name="cloud-upload-outline"></ion-icon>
                                    <p>Vagy tölts fel saját hátteret</p>
                                    <p class="small">Max. 5MB, JPG, PNG, GIF vagy WebP formátum</p>
                                </div>
                                <input type="file" id="custom-background-input" accept="image/jpeg,image/png,image/gif,image/webp" style="display: none;">
                                
                                <div class="upload-preview" id="background-preview" style="display: none;">
                                    <img id="background-preview-img" class="preview-image" src="" alt="Előnézet">
                                    <button class="btn-primary" onclick="uploadCustomBackground()">Háttér beállítása</button>
                                    <button class="btn-secondary" onclick="cancelBackgroundUpload()">Mégse</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Avatar módosító modal -->
    <div class="modal-overlay" id="avatar-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Profilkép módosítása</h3>
                <button class="modal-close" id="close-avatar-modal">&times;</button>
            </div>
            
            <div class="modal-body">
                <div class="upload-area" id="avatar-upload-area" style="margin-bottom: 20px;">
                    <ion-icon name="cloud-upload-outline"></ion-icon>
                    <p>Kattints ide vagy húzd ide a képet</p>
                    <p class="small">Max. 5MB, JPG, PNG, GIF vagy WebP formátum</p>
                </div>
                <input type="file" id="avatar-upload-input" accept="image/jpeg,image/png,image/gif,image/webp" style="display: none;">
                
                <div class="upload-progress" id="avatar-upload-progress" style="display: none; margin-bottom: 20px;">
        <div class="progress-bar">
            <div class="progress-fill" id="avatar-progress-fill" style="width: 0%"></div>
        </div>
        <div class="progress-text" id="avatar-progress-text">0%</div>
    </div>
    
    <div class="upload-preview" id="avatar-preview" style="display: none;">
        <img id="avatar-preview-img" class="preview-image" src="" alt="Előnézet">
        <div style="display: flex; gap: 10px; justify-content: center; margin-top: 15px;">
            <button class="btn-primary" onclick="saveAvatar()">Mentés</button>
            <button class="btn-secondary" onclick="cancelAvatarUpload()">Mégse</button>
        </div>
    </div>
                <div class="upload-preview" id="avatar-preview" style="display: none;">
                    <img id="avatar-preview-img" class="preview-image" src="" alt="Előnézet">
                    <div style="display: flex; gap: 10px; justify-content: center; margin-top: 15px;">
                        <button class="btn-primary" onclick="saveAvatar()">Mentés</button>
                        <button class="btn-secondary" onclick="cancelAvatarUpload()">Mégse</button>
                    </div>
                </div>
                
                <div style="margin-top: 30px; text-align: center;">
                    <p>Vagy válassz egy előre generált avatart:</p>
                    <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-top: 15px;">
                        <button class="btn-secondary" onclick="generateAvatar('initials')">Iniciálok</button>
                        <button class="btn-secondary" onclick="generateAvatar('abstract')">Absztrakt</button>
                        <button class="btn-secondary" onclick="generateAvatar('nature')">Természet</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="dashboard.js"></script>
    <script src="profildropdown.js"></script>
    
    <script>
    // Profil oldal JavaScript
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Profil oldal betöltve');
        
        // Navigáció beállítása
        setupProfileNavigation();
        
        // Profil betöltése
        loadUserProfile();
        
        // Eseménykezelők beállítása
        setupEventListeners();
        
        // Háttér opciók betöltése
        loadBackgroundOptions();
    });
    
    function setupProfileNavigation() {
        // Mobile menu kezelése
        const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
        const sidebar = document.getElementById('sidebar');
        const closeSidebar = document.querySelector('.close-sidebar');

        if (mobileMenuBtn) {
            mobileMenuBtn.addEventListener('click', function() {
                sidebar.classList.toggle('active');
            });
        }

        if (closeSidebar) {
            closeSidebar.addEventListener('click', function() {
                sidebar.classList.remove('active');
            });
        }

        document.addEventListener('click', function(event) {
            const isClickInsideSidebar = sidebar.contains(event.target);
            const isClickOnMenuBtn = mobileMenuBtn.contains(event.target);
            
            if (!isClickInsideSidebar && !isClickOnMenuBtn && sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
            }
        });
        
        // Aktív menüpont beállítása
        document.querySelectorAll('.navList').forEach(item => {
            item.classList.remove('active');
        });
        document.querySelector('.navList[data-target="profile"]').classList.add('active');
    }
    
    function setupEventListeners() {
        // Profilkép szerkesztése
        document.getElementById('edit-avatar-btn').addEventListener('click', openAvatarModal);
        document.getElementById('close-avatar-modal').addEventListener('click', closeAvatarModal);
        
        // Avatar upload
        document.getElementById('avatar-upload-area').addEventListener('click', () => {
            document.getElementById('avatar-upload-input').click();
        });
        
        document.getElementById('avatar-upload-input').addEventListener('change', handleAvatarUpload);
        
        // Háttér upload
        document.getElementById('upload-background-area').addEventListener('click', () => {
            document.getElementById('custom-background-input').click();
        });
        
        document.getElementById('custom-background-input').addEventListener('change', handleBackgroundUpload);
        
        // Alapvető információk form
        document.getElementById('basic-info-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            await saveBasicInfo();
        });
        
        // Dropdown menü
        const profileToggleBtn = document.getElementById('profile-toggle-btn');
        const profileDropdown = document.getElementById('profile-dropdown');
        
        if (profileToggleBtn) {
            profileToggleBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                profileDropdown.classList.toggle('active');
            });
        }
        
        document.addEventListener('click', function(e) {
            if (profileToggleBtn && !profileToggleBtn.contains(e.target) && 
                profileDropdown && !profileDropdown.contains(e.target)) {
                profileDropdown.classList.remove('active');
            }
        });
    }
    
    async function loadUserProfile() {
        console.log('Felhasználói profil betöltése...');
        
        const token = await getAuthToken();
        if (!token) {
            console.log('Nincs token - felhasználó nincs bejelentkezve');
            showGuestProfile();
            return;
        }
        
        try {
            // Először lekérjük a jelenlegi felhasználó adatait
            const userResponse = await fetch('/api/user/get', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    get: 'email, first_name, full_name, alias, roles, pfp, description, face, dc, yt, insta, wattpad, created_at'
                })
            });
            
            if (userResponse.ok) {
                const userData = await userResponse.json();
                console.log('Felhasználói adatok:', userData);
                
                // Profil adatok frissítése
                updateProfileDisplay(userData);
                
                // Statisztikák betöltése (cikkek száma)
                await loadUserStats(userData);
                
                // Formok kitöltése
                populateForms(userData);
            } else {
                console.error('Hiba a felhasználói adatok lekérése során');
                showGuestProfile();
            }

            // Profilkép frissítése a loadUserProfile() függvényben:
if (userData.pfp && userData.pfp.trim() !== '' && 
    userData.pfp !== 'null' && userData.pfp !== 'undefined') {
    
    // Ellenőrizzük, hogy Base64-e vagy URL-e
    if (userData.pfp.startsWith('data:image/')) {
        // Base64 kép
        avatarImg.src = userData.pfp;
        if (dropdownImg) dropdownImg.src = userData.pfp;
    } else if (userData.pfp.startsWith('http://') || userData.pfp.startsWith('https://')) {
        // Külső URL
        avatarImg.src = userData.pfp;
        if (dropdownImg) dropdownImg.src = userData.pfp;
    } else if (userData.pfp.startsWith('/')) {
        // Relatív útvonal
        avatarImg.src = userData.pfp;
        if (dropdownImg) dropdownImg.src = userData.pfp;
    } else {
        // Generált avatar
        const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=1891d1&color=fff&size=180`;
        avatarImg.src = avatarUrl;
        if (dropdownImg) dropdownImg.src = avatarUrl;
    }
} else {
    // Generált avatar
    const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=1891d1&color=fff&size=180`;
    avatarImg.src = avatarUrl;
    if (dropdownImg) dropdownImg.src = avatarUrl;
}
        } catch (error) {
            console.error('Hiba a profil betöltése során:', error);
            showGuestProfile();
        }
    }
    
    function updateProfileDisplay(userData) {
        console.log('Profil megjelenítés frissítése:', userData);
        
        // Név megjelenítése
        const displayName = document.getElementById('profile-display-name');
        const profileAlias = document.getElementById('profile-alias');
        const avatarImg = document.getElementById('profile-avatar-img');
        const dropdownImg = document.getElementById('user-profile-image');
        
        let userName = 'Felhasználó';
        
        if (userData.alias && userData.alias.trim() !== '') {
            userName = userData.alias;
        } else if (userData.full_name && userData.full_name.trim() !== '') {
            userName = userData.full_name;
        } else if (userData.first_name && userData.first_name.trim() !== '') {
            userName = userData.first_name;
        } else if (userData.email) {
            userName = userData.email.split('@')[0];
        }
        
        if (displayName) displayName.textContent = userName;
        
        // Email megjelenítése
        const emailElement = document.getElementById('profile-email');
        if (emailElement && userData.email) {
            emailElement.textContent = userData.email;
        }
        
        // Profilkép frissítése
        if (userData.pfp && userData.pfp.trim() !== '' && 
            userData.pfp !== 'null' && userData.pfp !== 'undefined' &&
            (userData.pfp.startsWith('http://') || userData.pfp.startsWith('https://'))) {
            
            avatarImg.src = userData.pfp;
            if (dropdownImg) dropdownImg.src = userData.pfp;
        } else {
            // Generált avatar
            const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=1891d1&color=fff&size=180`;
            avatarImg.src = avatarUrl;
            if (dropdownImg) dropdownImg.src = avatarUrl;
        }
        
        // Rangok megjelenítése
        displayUserRoles(userData.roles);
        
        // Dropdown frissítése
        updateDropdownContent(userData);
    }
    
    function displayUserRoles(rolesString) {
        const container = document.getElementById('profile-roles-container');
        if (!container) return;
        
        let rolesArray = [];
        
        if (rolesString) {
            try {
                if (typeof rolesString === 'string') {
                    rolesArray = JSON.parse(rolesString);
                } else if (Array.isArray(rolesString)) {
                    rolesArray = rolesString;
                }
            } catch (e) {
                console.error('Hiba a rangok parse-olása során:', e);
                rolesArray = rolesString.split(',').map(r => r.trim());
            }
        }
        
        if (rolesArray.length === 0) {
            container.innerHTML = '<span class="role-badge" style="background: #e5e7eb; color: #6b7280;">Nincs rang</span>';
            return;
        }
        
        let html = '';
        rolesArray.forEach(role => {
            const roleLower = role.toLowerCase();
            let roleClass = 'role-badge';
            
            if (roleLower.includes('writer')) roleClass += ' role-writer';
            else if (roleLower.includes('lector')) roleClass += ' role-lector';
            else if (roleLower.includes('director')) roleClass += ' role-director';
            else if (roleLower.includes('frontend')) roleClass += ' role-frontend';
            else if (roleLower.includes('backend')) roleClass += ' role-backend';
            else if (role === '*') roleClass += ' role-star';
            else roleClass += ' role-badge';
            
            html += `<span class="${roleClass}">${role}</span>`;
        });
        
        container.innerHTML = html;
    }
    
    async function loadUserStats(userData) {
        const articlesCount = document.getElementById('articles-count');
        const joinedDate = document.getElementById('joined-date');
        
        // Cikkek számának lekérése
        try {
            const token = await getAuthToken();
            const response = await fetch('/api/post/get/written?edited=false', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (response.ok) {
                const articles = await response.json();
                const count = Object.keys(articles).length;
                articlesCount.textContent = count;
            }
        } catch (error) {
            console.error('Hiba a cikkek számának lekérése során:', error);
            articlesCount.textContent = '0';
        }
        
        // Csatlakozás dátuma
        if (userData.created_at) {
            const date = new Date(userData.created_at);
            const formatted = date.toLocaleDateString('hu-HU', {
                year: 'numeric',
                month: 'short'
            });
            joinedDate.textContent = formatted;
        } else {
            joinedDate.textContent = '-';
        }
    }
    
    // Profilkép feltöltése Base64 formátumban
async function uploadProfilePictureBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        
        reader.onload = async (event) => {
            try {
                const base64Image = event.target.result;
                const token = await getAuthToken();
                
                if (!token) {
                    throw new Error('Nincs érvényes token');
                }
                
                const response = await fetch('/api/user/set', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        pfp: base64Image
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Profilkép beállítása sikertelen: ${errorText}`);
                }
                
                const data = await response.json();
                console.log('Profilkép mentve:', data);
                resolve(data);
            } catch (error) {
                reject(error);
            }
        };
        
        reader.onerror = () => reject(new Error('Fájl olvasása sikertelen'));
        reader.readAsDataURL(file);
    });
}

    function populateForms(userData) {
        // Alapvető információk
        document.getElementById('profile-alias').value = userData.alias || '';
        document.getElementById('profile-description').value = userData.description || '';
        document.getElementById('profile-face').value = userData.face || '';
        
        // Közösségi média
        document.getElementById('profile-dc').value = userData.dc || '';
        document.getElementById('profile-yt').value = userData.yt || '';
        document.getElementById('profile-instagram').value = userData.insta || '';
        document.getElementById('profile-wattpad').value = userData.wattpad || '';
    }
    
    function showGuestProfile() {
        const displayName = document.getElementById('profile-display-name');
        const emailElement = document.getElementById('profile-email');
        const rolesContainer = document.getElementById('profile-roles-container');
        
        if (displayName) displayName.textContent = 'Vendég';
        if (emailElement) emailElement.textContent = 'Nincs bejelentkezve';
        
        if (rolesContainer) {
            rolesContainer.innerHTML = '<span class="role-badge" style="background: #e5e7eb; color: #6b7280;">Vendég</span>';
        }
        
        // Statisztikák alaphelyzetbe állítása
        document.getElementById('articles-count').textContent = '0';
        document.getElementById('joined-date').textContent = '-';
        
        // Formok letiltása
        document.querySelectorAll('input, textarea, button').forEach(element => {
            if (!element.classList.contains('btn-secondary') && element.id !== 'edit-avatar-btn') {
                element.disabled = true;
            }
        });
        
        // Információs üzenet
        const mainContent = document.querySelector('.profile-main');
        const infoMessage = document.createElement('div');
        infoMessage.className = 'profile-settings-card';
        infoMessage.innerHTML = `
            <div style="text-align: center; padding: 40px 20px;">
                <ion-icon name="log-in-outline" style="font-size: 64px; color: #1891d1; margin-bottom: 20px;"></ion-icon>
                <h3 style="margin-bottom: 15px;">Nincs bejelentkezve</h3>
                <p style="margin-bottom: 25px; color: #6b7280;">Jelentkezz be a profilod szerkesztéséhez!</p>
                <button class="btn-primary" onclick="window.location.href='/api/login/google?redirect=${encodeURIComponent(window.location.pathname)}'">
                    <ion-icon name="logo-google"></ion-icon>
                    Bejelentkezés Google fiókkal
                </button>
            </div>
        `;
        
        // Az összes kártya elrejtése
        document.querySelectorAll('.profile-settings-card').forEach(card => {
            card.style.display = 'none';
        });
        
        // Információs üzenet beszúrása
        mainContent.insertBefore(infoMessage, mainContent.firstChild);
    }
    
    async function saveBasicInfo() {
        const token = await getAuthToken();
        if (!token) {
            showNotification('Nem vagy bejelentkezve!', 'error');
            return;
        }
        
        const updateData = {};
        
        // Adatok összegyűjtése
        const alias = document.getElementById('profile-alias').value.trim();
        const description = document.getElementById('profile-description').value.trim();
        const face = document.getElementById('profile-face').value.trim();
        
        if (alias) updateData.alias = alias;
        if (description) updateData.description = description;
        if (face) updateData.face = face;
        
        if (Object.keys(updateData).length === 0) {
            showNotification('Nincs módosítandó adat!', 'warning');
            return;
        }
        
        try {
            const response = await fetch('/api/user/set', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(updateData)
            });
            
            if (response.ok) {
                const result = await response.json();
                showNotification('Profil sikeresen frissítve!', 'success');
                console.log('Profil frissítés:', result);
                
                // Profil adatok újratöltése
                loadUserProfile();
            } else {
                const error = await response.text();
                showNotification(`Hiba: ${error}`, 'error');
            }
        } catch (error) {
            console.error('Hiba a profil frissítése során:', error);
            showNotification('Hiba történt a profil frissítése során!', 'error');
        }
    }
    
    async function saveSocialLinks() {
        const token = await getAuthToken();
        if (!token) {
            showNotification('Nem vagy bejelentkezve!', 'error');
            return;
        }
        
        const updateData = {};
        
        // Adatok összegyűjtése
        const dc = document.getElementById('profile-dc').value.trim();
        const yt = document.getElementById('profile-yt').value.trim();
        const insta = document.getElementById('profile-instagram').value.trim();
        const wattpad = document.getElementById('profile-wattpad').value.trim();
        
        if (dc) updateData.dc = dc;
        if (yt) updateData.yt = yt;
        if (insta) updateData.insta = insta;
        if (wattpad) updateData.wattpad = wattpad;
        
        if (Object.keys(updateData).length === 0) {
            showNotification('Nincs módosítandó adat!', 'warning');
            return;
        }
        
        try {
            const response = await fetch('/api/user/set', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(updateData)
            });
            
            if (response.ok) {
                const result = await response.json();
                showNotification('Közösségi média linkek frissítve!', 'success');
                console.log('Közösségi média frissítés:', result);
            } else {
                const error = await response.text();
                showNotification(`Hiba: ${error}`, 'error');
            }
        } catch (error) {
            console.error('Hiba a közösségi média frissítése során:', error);
            showNotification('Hiba történt a frissítés során!', 'error');
        }
    }
    
    async function changePassword() {
        const token = await getAuthToken();
        if (!token) {
            showNotification('Nem vagy bejelentkezve!', 'error');
            return;
        }
        
        const currentPassword = document.getElementById('current-password').value;
        const newPassword = document.getElementById('new-password').value;
        const confirmPassword = document.getElementById('confirm-password').value;
        
        // Validáció
        if (!currentPassword || !newPassword || !confirmPassword) {
            showNotification('Minden mező kitöltése kötelező!', 'warning');
            return;
        }
        
        if (newPassword.length < 6) {
            showNotification('Az új jelszónak legalább 6 karakter hosszúnak kell lennie!', 'warning');
            return;
        }
        
        if (newPassword !== confirmPassword) {
            showNotification('Az új jelszavak nem egyeznek!', 'error');
            return;
        }
        
        try {
            // Jelszó változtatás API hívás
            const response = await fetch('/api/user/change-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    current_password: currentPassword,
                    new_password: newPassword
                })
            });
            
            if (response.ok) {
                showNotification('Jelszó sikeresen megváltoztatva!', 'success');
                
                // Mezők ürítése
                document.getElementById('current-password').value = '';
                document.getElementById('new-password').value = '';
                document.getElementById('confirm-password').value = '';
            } else {
                const error = await response.text();
                showNotification(`Hiba: ${error}`, 'error');
            }
        } catch (error) {
            console.error('Hiba a jelszó változtatása során:', error);
            showNotification('Hiba történt a jelszó változtatása során!', 'error');
        }
    }
    
    function resetBasicInfoForm() {
        document.getElementById('basic-info-form').reset();
    }
    
    function resetSocialLinksForm() {
        document.getElementById('profile-dc').value = '';
        document.getElementById('profile-yt').value = '';
        document.getElementById('profile-instagram').value = '';
        document.getElementById('profile-wattpad').value = '';
    }
    
    function openAvatarModal() {
        const token = getAuthToken();
        if (!token) {
            showNotification('Nem vagy bejelentkezve!', 'error');
            return;
        }
        
        document.getElementById('avatar-modal').classList.add('active');
    }
    
    function closeAvatarModal() {
        document.getElementById('avatar-modal').classList.remove('active');
        document.getElementById('avatar-preview').style.display = 'none';
        document.getElementById('avatar-upload-input').value = '';
    }
    
function handleAvatarUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // Validáció
    const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
    if (!validTypes.includes(file.type)) {
        showNotification('Csak JPEG, PNG, GIF vagy WebP képek tölthetők fel!', 'error');
        return;
    }
    
    if (file.size > 5 * 1024 * 1024) {
        showNotification('A kép mérete nem haladhatja meg az 5MB-ot!', 'error');
        return;
    }
    
    // Előnézet megjelenítése
    const reader = new FileReader();
    reader.onload = function(e) {
        document.getElementById('avatar-preview-img').src = e.target.result;
        document.getElementById('avatar-preview').style.display = 'block';
        document.getElementById('avatar-upload-area').style.display = 'none';
        document.getElementById('avatar-upload-progress').style.display = 'none';
    };
    reader.readAsDataURL(file);
    
    window.currentAvatarFile = file;
}
    
    function cancelAvatarUpload() {
        document.getElementById('avatar-preview').style.display = 'none';
        document.getElementById('avatar-upload-area').style.display = 'block';
        document.getElementById('avatar-upload-input').value = '';
        window.currentAvatarFile = null;
    }
    
async function saveAvatar() {
    if (!window.currentAvatarFile) {
        showNotification('Nincs kép kiválasztva!', 'warning');
        return;
    }
    
    const token = await getAuthToken();
    if (!token) {
        showNotification('Nem vagy bejelentkezve!', 'error');
        return;
    }
    
    try {
        // A meglévő Base64 feltöltési függvény használata
        await uploadProfilePictureBase64(window.currentAvatarFile);
        
        showNotification('Profilkép sikeresen frissítve!', 'success');
        
        // Avatar frissítése a UI-ban
        const avatarImg = document.getElementById('profile-avatar-img');
        const dropdownImg = document.getElementById('user-profile-image');
        
        // Ideiglenes frissítés
        const reader = new FileReader();
        reader.onload = function(e) {
            avatarImg.src = e.target.result;
            if (dropdownImg) dropdownImg.src = e.target.result;
        };
        reader.readAsDataURL(window.currentAvatarFile);
        
        // Modal bezárása
        closeAvatarModal();
        
        // Várj egy kicsit, majd frissítsd a teljes profilt
        setTimeout(() => {
            loadUserProfile();
        }, 1000);
        
    } catch (error) {
        console.error('Hiba a profilkép feltöltése során:', error);
        showNotification('Hiba történt a feltöltés során: ' + error.message, 'error');
    }
}
    
    function generateAvatar(type) {
        const userName = document.getElementById('profile-display-name').textContent;
        let avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=1891d1&color=fff&size=180`;
        
        // Különböző avatar stílusok
        if (type === 'abstract') {
            avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=random&color=fff&bold=true&size=180`;
        } else if (type === 'nature') {
            avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=4CAF50&color=fff&size=180`;
        }
        
        // Avatar frissítése
        const avatarImg = document.getElementById('profile-avatar-img');
        const dropdownImg = document.getElementById('user-profile-image');
        
        avatarImg.src = avatarUrl;
        if (dropdownImg) dropdownImg.src = avatarUrl;
        
        // TODO: Avatar mentése a szerverre
        showNotification('Avatar frissítve!', 'success');
        
        // Modal bezárása
        closeAvatarModal();
    }
    
    function loadBackgroundOptions() {
        const container = document.getElementById('background-options');
        
        // Alap háttér opciók
        const backgrounds = [
            { id: 'default', name: 'Alapértelmezett', url: '/assets/backgrounds/default.jpg' },
            { id: 'gradient-1', name: 'Gradient 1', url: 'https://images.unsplash.com/photo-1557683316-973673baf926?w=600&auto=format&fit=crop' },
            { id: 'gradient-2', name: 'Gradient 2', url: 'https://images.unsplash.com/photo-1519681393784-d120267933ba?w-600&auto=format&fit=crop' },
            { id: 'nature', name: 'Természet', url: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=600&auto=format&fit=crop' },
            { id: 'abstract', name: 'Absztrakt', url: 'https://images.unsplash.com/photo-1513360371669-4adf3dd7dff8?w=600&auto=format&fit=crop' },
            { id: 'pattern', name: 'Minta', url: 'https://images.unsplash.com/photo-1550684376-efcbd6e3f031?w=600&auto=format&fit=crop' }
        ];
        
        let html = '';
        backgrounds.forEach(bg => {
            html += `
                <div class="background-option" data-bg-id="${bg.id}">
                    <img src="${bg.url}" alt="${bg.name}" class="background-preview">
                    <div class="background-overlay">
                        <button class="background-select-btn" onclick="selectBackground('${bg.id}')">
                            <ion-icon name="checkmark-outline"></ion-icon>
                            Kiválasztás
                        </button>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        
        // Aktív háttér kijelölése (localStorage-ből)
        const activeBg = localStorage.getItem('profileBackground') || 'default';
        document.querySelector(`[data-bg-id="${activeBg}"]`)?.classList.add('selected');
    }
    
    function selectBackground(bgId) {
        // Összes háttér opció kijelölésének törlése
        document.querySelectorAll('.background-option').forEach(option => {
            option.classList.remove('selected');
        });
        
        // Aktív háttér kijelölése
        document.querySelector(`[data-bg-id="${bgId}"]`)?.classList.add('selected');
        
        // Háttér mentése localStorage-ba
        localStorage.setItem('profileBackground', bgId);
        
        // Háttér alkalmazása
        applyBackground(bgId);
        
        showNotification('Háttér frissítve!', 'success');
    }
    
    function applyBackground(bgId) {
        // Háttér alkalmazása a profil oldalra
        const body = document.body;
        
        // Alapértelmezett hátter

                // Alapértelmezett háttér eltávolítása
        body.classList.remove('bg-default', 'bg-gradient-1', 'bg-gradient-2', 'bg-nature', 'bg-abstract', 'bg-pattern');
        
        // Új háttér hozzáadása
        if (bgId !== 'default') {
            body.classList.add(`bg-${bgId}`);
        }
        
        // TODO: Háttér mentése a szerverre API-n keresztül
        saveBackgroundToServer(bgId);
    }
    
    async function saveBackgroundToServer(bgId) {
        const token = await getAuthToken();
        if (!token) return;
        
        try {
            const response = await fetch('/api/user/set-background', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ background: bgId })
            });
            
            if (response.ok) {
                console.log('Háttér sikeresen mentve a szerverre');
            }
        } catch (error) {
            console.error('Hiba a háttér mentése során:', error);
        }
    }
    
    function handleBackgroundUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        // Validáció
        const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
        if (!validTypes.includes(file.type)) {
            showNotification('Csak JPEG, PNG, GIF vagy WebP képek tölthetők fel!', 'error');
            return;
        }
        
        if (file.size > 5 * 1024 * 1024) {
            showNotification('A kép mérete nem haladhatja meg az 5MB-ot!', 'error');
            return;
        }
        
        // Előnézet megjelenítése
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('background-preview-img').src = e.target.result;
            document.getElementById('background-preview').style.display = 'block';
            document.getElementById('upload-background-area').style.display = 'none';
        };
        reader.readAsDataURL(file);
        
        window.currentBackgroundFile = file;
    }
    
    function cancelBackgroundUpload() {
        document.getElementById('background-preview').style.display = 'none';
        document.getElementById('upload-background-area').style.display = 'block';
        document.getElementById('custom-background-input').value = '';
        window.currentBackgroundFile = null;
    }
    
    async function uploadCustomBackground() {
        if (!window.currentBackgroundFile) {
            showNotification('Nincs kép kiválasztva!', 'warning');
            return;
        }
        
        const token = await getAuthToken();
        if (!token) {
            showNotification('Nem vagy bejelentkezve!', 'error');
            return;
        }
        
        const formData = new FormData();
        formData.append('image', window.currentBackgroundFile);
        
        try {
            const response = await fetch('/api/upload/background', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                body: formData
            });
            
            if (response.ok) {
                const result = await response.json();
                showNotification('Egyedi háttér sikeresen feltöltve!', 'success');
                
                // Háttér alkalmazása
                if (result.url) {
                    applyCustomBackground(result.url);
                }
                
                // Reset
                cancelBackgroundUpload();
            } else {
                const error = await response.text();
                showNotification(`Hiba: ${error}`, 'error');
            }
        } catch (error) {
            console.error('Hiba a háttér feltöltése során:', error);
            showNotification('Hiba történt a feltöltés során!', 'error');
        }
    }
    
    function applyCustomBackground(url) {
        // Egyedi háttér alkalmazása
        const body = document.body;
        body.style.backgroundImage = `url('${url}')`;
        body.style.backgroundSize = 'cover';
        body.style.backgroundPosition = 'center';
        body.style.backgroundAttachment = 'fixed';
        
        // Mentés localStorage-ba
        localStorage.setItem('customProfileBackground', url);
        
        // TODO: Mentés a szerverre
        saveCustomBackgroundToServer(url);
    }
    
    async function saveCustomBackgroundToServer(url) {
        const token = await getAuthToken();
        if (!token) return;
        
        try {
            const response = await fetch('/api/user/set-background', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ background: url, is_custom: true })
            });
            
            if (response.ok) {
                console.log('Egyedi háttér sikeresen mentve a szerverre');
            }
        } catch (error) {
            console.error('Hiba az egyedi háttér mentése során:', error);
        }
    }
    
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.innerHTML = `
            <ion-icon name="${type === 'success' ? 'checkmark-circle' : 
                               type === 'error' ? 'alert-circle' : 
                               type === 'warning' ? 'warning' : 'information'}-outline"></ion-icon>
            <span>${message}</span>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.classList.add('show');
        }, 10);
        
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => {
                notification.remove();
            }, 300);
        }, 3000);
    }
    
    // Függvények a dashboard.js-ből
    async function getAuthToken() {
        console.log('Token lekérése...');
        
        const tokenSources = {
            'localStorage': localStorage.getItem('secret'),
            'sessionStorage': sessionStorage.getItem('secret'),
            'URL paraméter': new URLSearchParams(window.location.search).get('token')
        };
        
        let token = tokenSources['URL paraméter'];
        
        if (!token && tokenSources['localStorage']) {
            token = tokenSources['localStorage'];
        }
        
        if (!token && tokenSources['sessionStorage']) {
            token = tokenSources['sessionStorage'];
        }
        
        if (tokenSources['URL paraméter'] && !tokenSources['localStorage']) {
            localStorage.setItem('secret', tokenSources['URL paraméter']);
            const newUrl = window.location.pathname;
            window.history.replaceState({}, document.title, newUrl);
        }
        
        return token;
    }
    
    function updateDropdownContent(userData) {
        const dropdownContent = document.getElementById('dropdown-content');
        if (!dropdownContent) return;
        
        if (userData && Object.keys(userData).length > 0) {
            let rolesText = 'Nincs';
            if (userData.roles) {
                try {
                    if (typeof userData.roles === 'string') {
                        const roles = JSON.parse(userData.roles);
                        rolesText = Array.isArray(roles) ? roles.join(', ') : roles;
                    } else if (Array.isArray(userData.roles)) {
                        rolesText = userData.roles.join(', ');
                    }
                } catch (e) {
                    console.error('Hiba a rangok feldolgozásában:', e);
                }
            }
            
            const displayName = userData.alias || userData.full_name || userData.first_name || 'Felhasználó';
            const email = userData.email || '';
            
            dropdownContent.innerHTML = `
                <div class="dropdown-header">
                    <div class="dropdown-user-info">
                        <div class="dropdown-user-name">${displayName}</div>
                        <div class="dropdown-user-email">${email}</div>
                        <div class="dropdown-user-roles" style="font-size: 10px; margin-top: 4px; color: #666;">Rangok: ${rolesText}</div>
                    </div>
                </div>
                <div class="dropdown-divider"></div>
                <a href="profile.html" class="dropdown-item">
                    <ion-icon name="person-outline"></ion-icon>
                    <span>Profilom</span>
                </a>
                <a href="settings.html" class="dropdown-item">
                    <ion-icon name="settings-outline"></ion-icon>
                    <span>Beállítások</span>
                </a>
                <div class="dropdown-divider"></div>
                <a href="#" class="dropdown-item logout" onclick="logout()">
                    <ion-icon name="log-out-outline"></ion-icon>
                    <span>Kijelentkezés</span>
                </a>
            `;
            
        } else {
            dropdownContent.innerHTML = `
                <div class="dropdown-header">
                    <div class="dropdown-user-info">
                        <div class="dropdown-user-name">Nincs bejelentkezve.</div>
                        <div class="dropdown-user-email">Jelentkezz be a funkciók használatához</div>
                    </div>
                </div>
                <div class="dropdown-divider"></div>
                <a href="#" class="dropdown-item" onclick="window.location.href='/api/login/google?redirect=${encodeURIComponent(window.location.pathname)}'">
                    <ion-icon name="log-in-outline"></ion-icon>
                    <span>Bejelentkezés Google fiókkal</span>
                </a>
            `;
        }
    }
    
    function logout() {
        localStorage.removeItem('secret');
        sessionStorage.removeItem('secret');
        window.location.href = '/logout.php';
    }
    
    // Oldal betöltésekor alkalmazza a mentett hátteret
    document.addEventListener('DOMContentLoaded', function() {
        const savedBg = localStorage.getItem('profileBackground');
        const customBg = localStorage.getItem('customProfileBackground');
        
        if (customBg) {
            applyCustomBackground(customBg);
        } else if (savedBg && savedBg !== 'default') {
            selectBackground(savedBg);
        }
    });
    
    // Drag and drop támogatás
    document.addEventListener('DOMContentLoaded', function() {
        setupDragAndDrop();
    });
    
    function setupDragAndDrop() {
        const avatarUploadArea = document.getElementById('avatar-upload-area');
        const backgroundUploadArea = document.getElementById('upload-background-area');
        
        [avatarUploadArea, backgroundUploadArea].forEach(area => {
            if (!area) return;
            
            area.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.style.backgroundColor = '#e5e7eb';
            });
            
            area.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.style.backgroundColor = '';
            });
            
            area.addEventListener('drop', function(e) {
                e.preventDefault();
                this.style.backgroundColor = '';
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    
                    // Meghatározzuk, melyik upload area-ról van szó
                    if (this.id === 'avatar-upload-area') {
                        handleFileUpload(file, 'avatar');
                    } else if (this.id === 'upload-background-area') {
                        handleFileUpload(file, 'background');
                    }
                }
            });
        });
    }
    
    function handleFileUpload(file, type) {
        const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
        
        if (!validTypes.includes(file.type)) {
            showNotification('Csak képek tölthetők fel!', 'error');
            return;
        }
        
        if (file.size > 5 * 1024 * 1024) {
            showNotification('A fájl mérete nem haladhatja meg az 5MB-ot!', 'error');
            return;
        }
        
        if (type === 'avatar') {
            // Avatar modal megnyitása
            openAvatarModal();
            
            // Avatar előnézet
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('avatar-preview-img').src = e.target.result;
                document.getElementById('avatar-preview').style.display = 'block';
                document.getElementById('avatar-upload-area').style.display = 'none';
            };
            reader.readAsDataURL(file);
            window.currentAvatarFile = file;
            
        } else if (type === 'background') {
            // Háttér előnézet
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('background-preview-img').src = e.target.result;
                document.getElementById('background-preview').style.display = 'block';
                document.getElementById('upload-background-area').style.display = 'none';
            };
            reader.readAsDataURL(file);
            window.currentBackgroundFile = file;
        }
    }
    
    // CSS hozzáadása a testreszabott hátterekhez
    const style = document.createElement('style');
    style.textContent = `
        .bg-gradient-1 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .bg-gradient-2 {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .bg-nature {
            background: url('https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=1600&auto=format&fit=crop') center/cover fixed;
        }
        .bg-abstract {
            background: url('https://images.unsplash.com/photo-1513360371669-4adf3dd7dff8?w=1600&auto=format&fit=crop') center/cover fixed;
        }
        .bg-pattern {
            background: url('https://images.unsplash.com/photo-1550684376-efcbd6e3f031?w=1600&auto=format&fit=crop') center/cover fixed;
        }
    `;
    document.head.appendChild(style);
    </script>
</body>
</html>