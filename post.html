<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pap√≠r-Pelik√°n | Cikk</title>
    <link rel="icon" type="image/x-icon" href="/papirpelikan_hatternelkul.png">
    <link rel="stylesheet" href="/index.css">
    <link href="https://fonts.googleapis.com/css2?family=Abril+Fatface&display=swap" rel="stylesheet">
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
    <style>
        /* ... (a kor√°bbi CSS marad v√°ltozatlan) ... */
        :root {
            --profile-primary: #1891d1;
            --profile-secondary: #f8f9fa;
            --profile-text: #2d3748;
            --profile-text-light: #6b7280;
            --profile-border: #e5e7eb;
            --profile-card-bg: white;
        }
        
        body {
            background-color: #f0f2f5;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            line-height: 1.6;
        }
        
        .article-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .article-header {
            background: white;
            border-radius: 12px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        .article-category {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 8px 20px;
            background: var(--profile-primary);
            color: white;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 20px;
        }
        
        .category-icon {
            width: 24px;
            height: 24px;
        }
        
        .article-title {
            font-family: 'Abril Fatface', serif;
            font-size: 48px;
            color: var(--profile-text);
            margin-bottom: 20px;
            line-height: 1.2;
        }
        
        .article-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-top: 1px solid var(--profile-border);
            border-bottom: 1px solid var(--profile-border);
            margin: 30px 0;
            font-size: 14px;
            color: var(--profile-text-light);
        }
        
        .article-authors {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .author-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--profile-secondary);
            border-radius: 6px;
            text-decoration: none;
            color: var(--profile-text);
            transition: background 0.2s;
        }
        
        .author-item:hover {
            background: #e5e7eb;
        }
        
        .author-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .article-date {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .article-content {
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            font-size: 18px;
            line-height: 1.8;
        }
        
        .article-content h2, .article-content h3, .article-content h4 {
            font-family: 'Abril Fatface', serif;
            margin: 40px 0 20px 0;
            color: var(--profile-text);
        }
        
        .article-content h2 {
            font-size: 32px;
        }
        
        .article-content h3 {
            font-size: 26px;
        }
        
        .article-content h4 {
            font-size: 22px;
        }
        
        .article-content p {
            margin-bottom: 24px;
        }
        
        .article-content img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .article-image-left {
            float: left;
            margin: 0 20px 20px 0;
            max-width: 40%;
        }
        
        .article-image-right {
            float: right;
            margin: 0 0 20px 20px;
            max-width: 40%;
        }
        
        .article-footer {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 1px solid var(--profile-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .article-stats {
            display: flex;
            gap: 30px;
        }
        
        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--profile-text-light);
        }
        
        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: var(--profile-primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            transition: background 0.2s;
        }
        
        .back-button:hover {
            background: #1474a9;
        }
        
        .loading-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 500px;
            font-size: 18px;
            color: var(--profile-text-light);
        }
        
        .debug-info {
            background: #f8f9fa;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 12px;
            color: #6b7280;
            display: none;
        }
        
        .debug-toggle {
            background: #e5e7eb;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .article-image-featured {
            width: 100%;
            max-height: 400px;
            object-fit: cover;
            border-radius: 12px;
            margin: 20px 0 40px 0;
        }
        
        @media (max-width: 768px) {
            .article-title {
                font-size: 32px;
            }
            
            .article-header,
            .article-content {
                padding: 20px;
            }
            
            .article-meta {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .article-authors {
                flex-wrap: wrap;
            }
            
            .article-image-left,
            .article-image-right {
                float: none;
                max-width: 100%;
                margin: 20px 0;
            }
            
            .article-footer {
                flex-direction: column;
                gap: 20px;
                align-items: flex-start;
            }
            
            .article-image-featured {
                max-height: 250px;
            }
        }
    </style>
</head>
<body>
    <!-- Fejl√©c √©s navig√°ci√≥ ide ker√ºlhet (m√°sold be a f≈ëoldal fejl√©c√©t) -->
    
    <div class="article-container">
        <div id="loading" class="loading-container">
            <div>
                <ion-icon name="document-text-outline" style="font-size: 48px; margin-bottom: 20px; color: #d1d5db;"></ion-icon>
                <p style="text-align: center;">Cikk bet√∂lt√©se...</p>
                <p id="loading-details" style="text-align: center; font-size: 14px; color: #9ca3af;"></p>
            </div>
        </div>
        
        <div id="article-content" style="display: none;">
            <!-- Tartalom ide t√∂lt≈ëdik -->
        </div>
        
        <div id="article-error" style="display: none; text-align: center; padding: 60px 20px;">
            <div style="font-size: 72px; color: #d1d5db; margin-bottom: 20px;">üòï</div>
            <h2 id="error-title" style="color: #2d3748; margin-bottom: 15px;">Hiba t√∂rt√©nt</h2>
            <p id="error-message" style="color: #6b7280; margin-bottom: 30px;">
                A keresett cikk nem tal√°lhat√≥, vagy nincs publikus hozz√°f√©r√©se.
            </p>
            <button class="debug-toggle" onclick="toggleDebugInfo()">Hibakeres√©si inform√°ci√≥k mutat√°sa</button>
            <div id="debug-info" class="debug-info"></div>
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 30px;">
                <a href="/" class="back-button">
                    <ion-icon name="home-outline"></ion-icon>
                    F≈ëoldal
                </a>
                <a href="javascript:history.back()" class="back-button" style="background: #6b7280;">
                    <ion-icon name="arrow-back-outline"></ion-icon>
                    Vissza
                </a>
            </div>
        </div>
    </div>

    <script>
        let debugData = {
            url: '',
            requestData: '',
            responseStatus: '',
            responseText: '',
            error: ''
        };
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Cikk oldal bet√∂ltve');
            
            // URL param√©terek kinyer√©se
            const urlParams = new URLSearchParams(window.location.search);
            const pid = urlParams.get('pid');
            const edited = urlParams.get('edited') === 'true';
            
            document.getElementById('loading-details').textContent = `Cikk ID: ${pid || 'nincs'} | Edited: ${edited}`;
            
            if (pid) {
                loadArticle(pid, edited);
            } else {
                showError('Nincs cikk ID megadva');
            }
        });
        
        async function getAuthToken() {
            const tokenSources = {
                'localStorage': localStorage.getItem('secret'),
                'sessionStorage': sessionStorage.getItem('secret'),
                'URL param√©ter': new URLSearchParams(window.location.search).get('token')
            };
            
            let token = tokenSources['URL param√©ter'];
            
            if (!token && tokenSources['localStorage']) {
                token = tokenSources['localStorage'];
            }
            
            if (!token && tokenSources['sessionStorage']) {
                token = tokenSources['sessionStorage'];
            }
            
            if (tokenSources['URL param√©ter'] && !tokenSources['localStorage']) {
                localStorage.setItem('secret', tokenSources['URL param√©ter']);
                const newUrl = window.location.pathname + window.location.search;
                window.history.replaceState({}, document.title, newUrl.split('?')[0]);
            }
            
            return token;
        }
        
        async function loadArticle(pid, edited = false) {
            console.log(`Cikk bet√∂lt√©se: ${pid}, edited: ${edited}`);
            
            const token = await getAuthToken();
            const requestData = {
                post: parseInt(pid),
                edited: edited
            };
            
            debugData.url = '/api/post/get/contents';
            debugData.requestData = JSON.stringify(requestData);
            
            try {
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                // Ha van token, adjuk hozz√° a header-hez
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                
                document.getElementById('loading-details').textContent = `API h√≠v√°s: /api/post/get/contents`;
                
                const response = await fetch('/api/post/get/contents', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(requestData)
                });
                
                debugData.responseStatus = `${response.status} ${response.statusText}`;
                
                const responseText = await response.text();
                debugData.responseText = responseText.substring(0, 500) + (responseText.length > 500 ? '...' : '');
                
                console.log('API v√°lasz st√°tusz:', response.status);
                console.log('API v√°lasz sz√∂veg:', responseText.substring(0, 200));
                
                if (response.ok) {
                    try {
                        const data = JSON.parse(responseText);
                        console.log('API v√°lasz adatok:', data);
                        displayArticle(data);
                    } catch (parseError) {
                        console.error('Nem siker√ºlt JSON-k√©nt √©rtelmezni:', parseError);
                        showError('Hib√°s adatok √©rkeztek a szervert≈ël');
                    }
                } else if (response.status === 403) {
                    showError('Nincs jogosults√°god megtekinteni ezt a cikket. Lehet, hogy m√©g nem jelent meg, vagy nem vagy bejelentkezve.');
                } else if (response.status === 404) {
                    showError('A cikk nem tal√°lhat√≥');
                } else if (response.status === 500) {
                    showError('Szerverhiba t√∂rt√©nt. K√©rlek, pr√≥b√°ld √∫jra k√©s≈ëbb.');
                } else {
                    showError(`Hiba t√∂rt√©nt: ${response.status} ${response.statusText}`);
                }
                
            } catch (error) {
                debugData.error = error.message;
                console.error('H√°l√≥zati hiba:', error);
                showError('H√°l√≥zati hiba t√∂rt√©nt. Ellen≈ërizd az internetkapcsolatod.');
            }
        }
        
        function displayArticle(articleData) {
            const loading = document.getElementById('loading');
            const articleContent = document.getElementById('article-content');
            const articleError = document.getElementById('article-error');
            
            loading.style.display = 'none';
            articleError.style.display = 'none';
            
            // Ellen≈ërizz√ºk, hogy valid adatokat kaptunk-e
            if (!articleData || typeof articleData !== 'object') {
                showError('√ârv√©nytelen adatok √©rkeztek');
                return;
            }
            
            // Alap HTML strukt√∫ra
            let html = `
                <div class="article-header">
                    <div id="article-category" class="article-category">
                        <!-- Kateg√≥ria ide t√∂lt≈ëdik -->
                    </div>
                    
                    ${articleData.number ? `
                        <div style="margin-bottom: 10px; color: var(--profile-text-light); font-size: 14px; display: flex; align-items: center; gap: 8px;">
                            <ion-icon name="book-outline"></ion-icon>
                            <span>Lapsz√°m: ${articleData.number}</span>
                        </div>
                    ` : ''}
                    
                    <h1 id="article-title" class="article-title">${escapeHtml(articleData.title) || 'C√≠m n√©lk√ºl'}</h1>
                    
                    <div class="article-meta">
                        <div id="article-authors" class="article-authors">
                            <!-- Szerz≈ëk ide t√∂lt≈ëdnek -->
                        </div>
                        <div class="article-date">
                            <ion-icon name="calendar-outline"></ion-icon>
                            <span id="article-date-text">${formatDate(articleData.created)}</span>
                        </div>
                    </div>
                    
                    ${articleData.minimal_desc ? `
                        <div id="article-minimal-desc" style="color: var(--profile-text-light); font-style: italic; margin-top: 20px; padding: 15px; background: var(--profile-secondary); border-radius: 8px;">
                            ${escapeHtml(articleData.minimal_desc)}
                        </div>
                    ` : ''}
                </div>
            `;
            
            // Kiemelt k√©p, ha van
            if (articleData.image) {
                html += `
                    <div style="margin-bottom: 30px;">
                        <img src="${articleData.image}" alt="${escapeHtml(articleData.title)}" class="article-image-featured">
                    </div>
                `;
            }
            
            // Cikk tartalma
            html += `
                <div id="article-body" class="article-content">
                    ${articleData.desc || '<p style="text-align: center; color: #6b7280; font-style: italic;">A cikk tartalma jelenleg nem el√©rhet≈ë.</p>'}
                </div>
            `;
            
            // L√°bl√©c
            html += `
                <div class="article-footer">
                    <div class="article-stats">
                        ${articleData.eid ? `
                            <div class="stat-item">
                                <ion-icon name="create-outline"></ion-icon>
                                <span>Szerkesztve: ${formatDate(articleData.last_edited)}</span>
                            </div>
                        ` : ''}
                        <div class="stat-item">
                            <ion-icon name="information-circle-outline"></ion-icon>
                            <span>Cikk ID: ${articleData.post}</span>
                        </div>
                    </div>
                    <a href="javascript:history.back()" class="back-button">
                        <ion-icon name="arrow-back-outline"></ion-icon>
                        Vissza
                    </a>
                </div>
            `;
            
            articleContent.innerHTML = html;
            articleContent.style.display = 'block';
            
            // Kateg√≥ria be√°ll√≠t√°sa
            const category = articleData.category || '√Åltal√°nos';
            const categoryIcon = getCategoryIcon(category);
            const categoryColor = getCategoryColor(category);
            
            const categoryElement = document.getElementById('article-category');
            if (categoryElement) {
                categoryElement.innerHTML = `
                    <img src="${categoryIcon}" alt="${category}" class="category-icon">
                    <span>${category}</span>
                `;
                categoryElement.style.backgroundColor = categoryColor;
            }
            
            // Szerz≈ëk be√°ll√≠t√°sa - el≈ësz√∂r bet√∂ltj√ºk a szerz≈ëk adatait
            loadAuthors(articleData.authors || []);
            
            // Oldal c√≠m√©nek be√°ll√≠t√°sa
            document.title = `Pap√≠r-Pelik√°n | ${articleData.title || 'Cikk'}`;
        }
        
        async function loadAuthors(authorIds) {
            const authorsContainer = document.getElementById('article-authors');
            if (!authorsContainer || !Array.isArray(authorIds) || authorIds.length === 0) {
                authorsContainer.innerHTML = '<span>Ismeretlen szerz≈ë</span>';
                return;
            }
            
            // T√∂lts√ºk be a szerz≈ëk adatait
            const authors = [];
            
            for (const authorId of authorIds) {
                try {
                    const response = await fetch(`/api/user/getone?uid=${authorId}`);
                    if (response.ok) {
                        const authorData = await response.json();
                        authors.push(authorData);
                    } else {
                        // Ha nem siker√ºl, haszn√°ljunk alap√©rtelmezett adatokat
                        authors.push({
                            uid: authorId,
                            name: `Szerz≈ë ${authorId}`,
                            pfp: null
                        });
                    }
                } catch (error) {
                    console.error(`Hiba a szerz≈ë bet√∂lt√©se sor√°n (${authorId}):`, error);
                    authors.push({
                        uid: authorId,
                        name: `Szerz≈ë ${authorId}`,
                        pfp: null
                    });
                }
            }
            
            // Jelen√≠ts√ºk meg a szerz≈ëket
            authorsContainer.innerHTML = '';
            authors.forEach(author => {
                const authorLink = document.createElement('a');
                authorLink.className = 'author-item';
                authorLink.href = `/user-profile.html?uid=${author.uid || author.id || ''}`;
                authorLink.innerHTML = `
                    <img src="${author.pfp || getDefaultAvatar(author.name || `Szerz≈ë ${author.uid}`)}" 
                         alt="${author.name || `Szerz≈ë ${author.uid}`}" 
                         class="author-avatar">
                    <span>${author.name || `Szerz≈ë ${author.uid}`}</span>
                `;
                authorsContainer.appendChild(authorLink);
            });
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function formatDate(dateString) {
            if (!dateString) return 'Ismeretlen d√°tum';
            
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('hu-HU', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            } catch (error) {
                return dateString;
            }
        }
        
        function getDefaultAvatar(name) {
            return `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=1891d1&color=fff&size=32&format=png`;
        }
        
        function showError(message) {
            const loading = document.getElementById('loading');
            const articleContent = document.getElementById('article-content');
            const articleError = document.getElementById('article-error');
            
            loading.style.display = 'none';
            articleContent.style.display = 'none';
            articleError.style.display = 'block';
            
            document.getElementById('error-message').textContent = message;
            
            console.error('Hiba:', message);
        }
        
        function toggleDebugInfo() {
            const debugInfo = document.getElementById('debug-info');
            debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
            
            debugInfo.innerHTML = `
                <strong>URL:</strong> ${debugData.url || 'N/A'}<br>
                <strong>Request:</strong> ${debugData.requestData || 'N/A'}<br>
                <strong>St√°tusz:</strong> ${debugData.responseStatus || 'N/A'}<br>
                <strong>V√°lasz:</strong> ${debugData.responseText || 'N/A'}<br>
                <strong>Hiba:</strong> ${debugData.error || 'N/A'}<br>
                <strong>D√°tum:</strong> ${new Date().toLocaleString()}<br>
                <strong>Token:</strong> ${localStorage.getItem('secret') ? 'Van (rejtve)' : 'Nincs'}
            `;
        }
        
        // Kateg√≥ria ikonok √©s sz√≠nek
        function getCategoryIcon(categoryName) {
            const iconMap = {
                'hitelet': '/Rovatok/Rovatok-ikon/hitelet.svg',
                'onallo': '/Rovatok/Rovatok-ikon/onallo.svg',
                'deutschblick': '/Rovatok/Rovatok-ikon/deutschblick.svg',
                'rangers': '/Rovatok/Rovatok-ikon/rangers.svg',
                'iskolank elete': '/Rovatok/Rovatok-ikon/iskolankelete.svg',
                'Iskol√°nk √©lete': '/Rovatok/Rovatok-ikon/iskolankelete.svg',
                'divatrovat': '/Rovatok/Rovatok-ikon/divat.svg',
                'divat': '/Rovatok/Rovatok-ikon/divatrovat.svg',
                'aj√°nl√≥ink': '/Rovatok/Rovatok-ikon/ajanloink.svg',
                'lic-tech': '/Rovatok/Rovatok-ikon/lictech.svg',
                'lictech': '/Rovatok/Rovatok-ikon/lictech.svg',
                'tech': '/Rovatok/Rovatok-ikon/lictech.svg',
                'irodalom': '/Rovatok/Rovatok-ikon/irodalom.svg',
                'm≈±v√©szet': '/Rovatok/Rovatok-ikon/muveszet.svg',
                'muveszet': '/Rovatok/Rovatok-ikon/muveszet.svg',
                '√©rdekess√©gek a vil√°gb√≥l': '/Rovatok/Rovatok-ikon/erdekessegek.svg',
                'erdekessegek': '/Rovatok/Rovatok-ikon/erdekessegek.svg',
                '√©rdekess√©gek': '/Rovatok/Rovatok-ikon/erdekessegek.svg',
                'vil√°g': '/Rovatok/Rovatok-ikon/erdekessegek.svg',
                'horg√°szrovat': '/Rovatok/Rovatok-ikon/horgaszrovat.svg',
                'horg√°sz': '/Rovatok/Rovatok-ikon/horgaszrovat.svg',
                'receptrovat': '/Rovatok/Rovatok-ikon/receptrovat.svg',
                'recept': '/Rovatok/Rovatok-ikon/receptrovat.svg',
                '√°ltal√°nos': '/Rovatok/Rovatok-ikon/altalanos.svg',
                'altalanos': '/Rovatok/Rovatok-ikon/altalanos.svg',
                'egy√©b': '/Rovatok/Rovatok-ikon/altalanos.svg',
                'm√°s': '/Rovatok/Rovatok-ikon/altalanos.svg'
            };
            
            const normalizedCategory = (categoryName || '')
                .toLowerCase()
                .trim()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            
            if (iconMap[normalizedCategory]) {
                return iconMap[normalizedCategory];
            }
            
            for (const [key, value] of Object.entries(iconMap)) {
                if (normalizedCategory.includes(key) && key !== '√°ltal√°nos' && key !== 'altalanos' && key !== 'egy√©b' && key !== 'm√°s') {
                    return value;
                }
            }
            
            return iconMap['altalanos'] || '/Rovatok/Rovatok-ikon/altalanos.svg';
        }
        
        function getCategoryColor(categoryName) {
            const colorMap = {
                'hitelet': '#424485',
                'onallo': '#9BC2D3',
                'deutschblick': '#F59E0B',
                'rangers': '#C50225',
                'iskolank elete': '#006188',
                'divatrovat': '#006188',
                'divat': '#006188',
                'ajanloink': '#5D729C',
                'lic-tech': '#00563F',
                'lictech': '#00563F',
                'tech': '#00563F',
                'irodalom': '#8B5CF6',
                'm≈±v√©szet': '#F59E0B',
                'muveszet': '#F59E0B',
                '√©rdekess√©gek a vil√°gb√≥l': '#10B981',
                'erdekessegek': '#10B981',
                '√©rdekess√©gek': '#10B981',
                'vil√°g': '#10B981',
                'horg√°szrovat': '#3B82F6',
                'horg√°sz': '#3B82F6',
                'receptrovat': '#F59E0B',
                'recept': '#F59E0B',
                '√°ltal√°nos': '#6B7280',
                'altalanos': '#6B7280',
                'egy√©b': '#6B7280',
                'm√°s': '#6B7280'
            };
            
            const normalizedCategory = (categoryName || '')
                .toLowerCase()
                .trim()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            
            if (colorMap[normalizedCategory]) {
                return colorMap[normalizedCategory];
            }
            
            for (const [key, value] of Object.entries(colorMap)) {
                if (normalizedCategory.includes(key) && key !== '√°ltal√°nos' && key !== 'altalanos' && key !== 'egy√©b' && key !== 'm√°s') {
                    return value;
                }
            }
            
            return colorMap['altalanos'] || '#6B7280';
        }
    </script>
</body>
</html>